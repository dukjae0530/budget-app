<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="My Account Manager">
<meta name="theme-color" content="#667eea">
<title>My Account Manager</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
@import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap');

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}

:root{
  --primary:#667eea;--primary-dark:#764ba2;
  --green:#2ECC71;--red:#E74C3C;--blue:#1E88E5;
  --bg:#F5F6FA;--card:#fff;--text:#333;--text-light:#888;
  --shadow:0 2px 12px rgba(0,0,0,0.06);--radius:18px;
}

body{
  font-family:'Noto Sans KR','Poppins',-apple-system,sans-serif;
  background:var(--bg);color:var(--text);
  max-width:480px;margin:0 auto;min-height:100vh;min-height:100dvh;
  padding-bottom:80px;overflow-x:hidden;
}

/* Header */
.header{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  padding:48px 20px 20px;border-radius:0 0 28px 28px;
  box-shadow:0 4px 20px rgba(102,126,234,0.3);position:relative;overflow:hidden;
}
.header::before{content:'';position:absolute;top:-50%;right:-30%;width:200px;height:200px;background:rgba(255,255,255,0.08);border-radius:50%;}
.header-inner{display:flex;align-items:center;gap:12px;position:relative;z-index:1;}
.header .logo{font-size:32px;}
.header h1{font-size:18px;font-weight:800;color:#fff;letter-spacing:0.5px;font-family:'Poppins',sans-serif;}
.header .subtitle{font-size:12px;color:rgba(255,255,255,0.8);margin-left:auto;font-weight:500;}

/* Currency Selector in Header */
.currency-sel{
  background:rgba(255,255,255,0.2);border:1px solid rgba(255,255,255,0.3);
  color:#fff;border-radius:8px;padding:4px 8px;font-size:12px;
  font-family:inherit;outline:none;cursor:pointer;
}
.currency-sel option{color:#333;background:#fff;}

/* Tab Bar */
.tab-bar{
  display:flex;justify-content:space-around;background:var(--card);
  margin:12px 16px 0;border-radius:16px;padding:6px 4px;
  box-shadow:var(--shadow);position:sticky;top:0;z-index:50;
}
.tab-btn{
  display:flex;flex-direction:column;align-items:center;gap:2px;
  border:none;background:transparent;cursor:pointer;
  padding:8px 10px;border-radius:12px;transition:all 0.25s;font-family:inherit;
}
.tab-btn.active{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  transform:scale(1.05);box-shadow:0 2px 10px rgba(102,126,234,0.3);
}
.tab-btn.active .tab-label{color:#fff;}
.tab-icon{font-size:18px;}.tab-label{font-size:10px;font-weight:600;color:#555;}

.content{padding:12px 16px;}

/* Balance Card */
.balance-card{
  background:linear-gradient(135deg,#2c3e50,#3498db);
  border-radius:20px;padding:24px 20px;color:#fff;
  margin-bottom:16px;box-shadow:0 4px 20px rgba(52,152,219,0.3);
  position:relative;overflow:hidden;
}
.balance-card::after{content:'';position:absolute;bottom:-20px;right:-20px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,0.05);}
.balance-label{font-size:13px;opacity:0.8;margin-bottom:4px;}
.balance-amount{font-size:30px;font-weight:800;margin-bottom:12px;}
.balance-row{display:flex;gap:20px;font-size:13px;opacity:0.9;}

/* Stats Grid */
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;}
.stat-card{border-radius:16px;padding:14px 12px;color:#fff;box-shadow:0 2px 10px rgba(0,0,0,0.08);transition:transform 0.2s;}
.stat-card:active{transform:scale(0.97);}
.stat-emoji{font-size:22px;margin-bottom:4px;}
.stat-label{font-size:11px;opacity:0.9;margin-bottom:2px;}
.stat-value{font-size:14px;font-weight:700;}

/* Card */
.card{background:var(--card);border-radius:var(--radius);padding:18px 16px;margin-bottom:14px;box-shadow:var(--shadow);}
.card-title{font-size:16px;font-weight:700;margin-bottom:12px;}
.card-desc{font-size:13px;color:var(--text-light);margin-bottom:12px;line-height:1.5;}
.card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;}
.empty-text{color:#bbb;font-size:14px;text-align:center;padding:20px 0;}

/* Inputs */
.input-row{display:flex;align-items:center;gap:8px;}
.input{
  flex:1;border:2px solid #E8E8E8;border-radius:12px;
  padding:10px 14px;font-size:15px;outline:none;
  font-family:inherit;transition:border 0.2s;
}
.input:focus{border-color:var(--primary);}
.input-unit{font-size:14px;color:var(--text-light);font-weight:600;}

/* Fixed Items */
.fixed-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #f0f0f0;}
.fixed-name{font-weight:600;font-size:14px;}
.fixed-cat{font-size:11px;color:#999;margin-left:8px;background:#f5f5f5;padding:2px 8px;border-radius:10px;}
.fixed-right{display:flex;align-items:center;gap:8px;}
.fixed-amount{font-weight:700;font-size:14px;}
.fixed-total{text-align:right;padding-top:12px;font-size:14px;color:#666;}

/* Record Row */
.record-row{display:flex;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid #f5f5f5;}
.record-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.record-info{flex:1;display:flex;flex-direction:column;gap:2px;min-width:0;}
.record-cat{font-weight:600;font-size:13px;}
.record-date{font-size:11px;color:#999;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.record-amount{font-weight:700;font-size:13px;flex-shrink:0;}

/* Labels */
.label-tags{display:flex;flex-wrap:wrap;gap:4px;margin-top:3px;}
.label-tag{
  font-size:10px;padding:1px 7px;border-radius:8px;
  font-weight:600;white-space:nowrap;
}

/* Label Filter Bar */
.label-filter-bar{
  display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px;
  padding:10px 12px;background:var(--card);border-radius:12px;
  box-shadow:var(--shadow);
}
.label-filter-btn{
  font-size:11px;padding:4px 10px;border-radius:10px;
  border:2px solid #E0E0E0;background:#fff;cursor:pointer;
  font-family:inherit;font-weight:600;color:#666;transition:all 0.2s;
}
.label-filter-btn.active{
  border-color:var(--primary);background:var(--primary);color:#fff;
}

/* Buttons */
.add-btn{
  background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;border:none;border-radius:10px;
  padding:6px 14px;font-size:13px;font-weight:600;cursor:pointer;font-family:inherit;
}
.big-add-btn{
  width:100%;background:linear-gradient(135deg,var(--primary),var(--primary-dark));
  color:#fff;border:none;border-radius:14px;padding:14px;font-size:15px;
  font-weight:700;cursor:pointer;margin-bottom:14px;font-family:inherit;
  box-shadow:0 4px 15px rgba(102,126,234,0.3);transition:transform 0.2s;
}
.big-add-btn:active{transform:scale(0.97);}
.delete-btn{background:none;border:none;color:#ccc;cursor:pointer;font-size:16px;padding:4px 6px;}

/* Month Selector */
.month-selector{
  display:flex;justify-content:center;align-items:center;gap:20px;
  margin-bottom:14px;background:var(--card);border-radius:14px;
  padding:10px;box-shadow:var(--shadow);
}
.month-btn{background:var(--primary);color:#fff;border:none;border-radius:8px;width:36px;height:36px;font-size:16px;cursor:pointer;}
.month-label{font-size:17px;font-weight:700;}

/* Prediction */
.predict-row{display:flex;align-items:center;padding:10px 12px;border-radius:10px;margin-bottom:4px;}
.predict-row:nth-child(even){background:#FAFAFA;}
.predict-month{font-weight:700;font-size:13px;width:75px;display:flex;align-items:center;gap:4px;}
.badge{font-size:9px;color:#fff;padding:1px 6px;border-radius:8px;font-weight:600;}
.badge-current{background:#FFC107;}.badge-future{background:#90CAF9;}
.predict-details{flex:1;display:flex;gap:10px;font-size:11px;font-weight:500;}
.predict-balance{font-weight:700;font-size:13px;text-align:right;min-width:80px;}

/* Category */
.category-row{display:flex;align-items:center;gap:8px;padding:6px 0;}
.category-dot{width:12px;height:12px;border-radius:50%;}
.category-name{flex:1;font-size:13px;color:#555;}
.category-val{font-weight:600;font-size:13px;}

/* Chart */
.chart-area{width:100%;position:relative;margin:8px 0;}
.chart-bar-container{display:flex;align-items:flex-end;justify-content:space-around;height:200px;padding:0 10px;border-bottom:2px solid #eee;}
.chart-bar-group{display:flex;flex-direction:column;align-items:center;gap:4px;}
.chart-bar-pair{display:flex;gap:4px;align-items:flex-end;height:180px;}
.chart-bar{width:22px;border-radius:6px 6px 0 0;transition:height 0.5s ease;position:relative;}
.chart-bar:hover::after{
  content:attr(data-value);position:absolute;top:-24px;left:50%;
  transform:translateX(-50%);font-size:10px;font-weight:600;
  background:rgba(0,0,0,0.7);color:#fff;padding:2px 6px;
  border-radius:4px;white-space:nowrap;
}
.chart-label{font-size:11px;color:#999;font-weight:500;}
.chart-legend{display:flex;justify-content:center;gap:16px;margin-top:8px;font-size:12px;}
.legend-item{display:flex;align-items:center;gap:4px;}
.legend-dot{width:10px;height:10px;border-radius:3px;}
.chart-svg{width:100%;overflow:visible;}
.chart-axis-label{font-size:10px;fill:#999;font-family:'Noto Sans KR',sans-serif;}

/* Special Cards */
.insight-card{background:linear-gradient(135deg,#FFF8E1,#FFECB3);border-radius:var(--radius);padding:18px 16px;margin-bottom:14px;}
.insight-text{font-size:14px;line-height:1.7;color:#555;}
.summary-card{background:linear-gradient(135deg,#E8F5E9,#FFF3E0);border-radius:var(--radius);padding:18px 16px;margin-bottom:14px;text-align:center;}
.summary-amount{font-size:28px;font-weight:700;padding:10px 0;}
.summary-desc{font-size:13px;color:#888;margin-top:4px;}
.predict-card{background:linear-gradient(135deg,#E3F2FD,#F3E5F5);border-radius:var(--radius);padding:18px 16px;margin-bottom:14px;}

/* Modal */
.overlay{
  position:fixed;top:0;left:0;right:0;bottom:0;
  background:rgba(0,0,0,0.5);display:flex;
  justify-content:center;align-items:center;
  z-index:100;padding:20px;animation:fadeIn 0.2s ease;
}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
.modal{
  background:#fff;border-radius:24px;padding:24px 20px;
  width:100%;max-width:400px;max-height:90vh;
  overflow:auto;animation:slideUp 0.3s ease;
}
@keyframes slideUp{from{transform:translateY(20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal-title{font-size:18px;font-weight:700;margin-bottom:16px;text-align:center;}
.modal label{font-size:12px;font-weight:600;color:#888;margin-bottom:4px;display:block;margin-top:12px;}
.modal-input{
  width:100%;border:2px solid #E8E8E8;border-radius:12px;
  padding:10px 14px;font-size:15px;outline:none;
  font-family:inherit;transition:border 0.2s;
}
.modal-input:focus{border-color:var(--primary);}
.modal-btns{display:flex;gap:10px;margin-top:20px;}
.cancel-btn{flex:1;background:#f0f0f0;border:none;border-radius:12px;padding:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;color:#888;}
.confirm-btn{flex:1;background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;border:none;border-radius:12px;padding:12px;font-size:14px;font-weight:600;cursor:pointer;font-family:inherit;}

/* Label Chips in Modal */
.label-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px;}
.label-chip{
  font-size:12px;padding:5px 12px;border-radius:20px;
  border:2px solid #E0E0E0;background:#fff;cursor:pointer;
  font-family:inherit;font-weight:500;color:#666;transition:all 0.2s;
}
.label-chip.selected{border-color:var(--primary);background:rgba(102,126,234,0.1);color:var(--primary);}
.label-chip-add{
  font-size:12px;padding:5px 12px;border-radius:20px;
  border:2px dashed #ccc;background:#fff;cursor:pointer;
  font-family:inherit;font-weight:500;color:#999;
}
.new-label-input{
  border:2px solid var(--primary);border-radius:20px;
  padding:4px 10px;font-size:12px;outline:none;width:100px;
  font-family:inherit;
}

/* Tab Content */
.tab-content{display:none;}.tab-content.active{display:block;animation:fadeIn 0.3s ease;}

/* Danger Zone */
.danger-zone{margin-top:20px;}
.reset-btn{
  width:100%;background:#fff;border:2px solid #E74C3C;
  border-radius:12px;padding:12px;font-size:14px;
  font-weight:600;cursor:pointer;font-family:inherit;
  color:#E74C3C;transition:all 0.2s;
}
.reset-btn:active{background:#E74C3C;color:#fff;}
</style>
</head>
<body>

<div class="header">
  <div class="header-inner">
    <span class="logo">ğŸ’</span>
    <h1>My Account Manager</h1>
    <select class="currency-sel" id="currencySelect" onchange="changeCurrency(this.value)">
      <option value="KRW">â‚© KRW</option>
      <option value="USD">$ USD</option>
      <option value="EUR">â‚¬ EUR</option>
      <option value="JPY">Â¥ JPY</option>
      <option value="GBP">Â£ GBP</option>
      <option value="CNY">Â¥ CNY</option>
    </select>
  </div>
</div>

<div class="tab-bar">
  <button class="tab-btn active" data-tab="home"><span class="tab-icon">ğŸ </span><span class="tab-label">í™ˆ</span></button>
  <button class="tab-btn" data-tab="fixed"><span class="tab-icon">ğŸ“Œ</span><span class="tab-label">ê³ ì •</span></button>
  <button class="tab-btn" data-tab="record"><span class="tab-icon">ğŸ“</span><span class="tab-label">ê¸°ë¡</span></button>
  <button class="tab-btn" data-tab="analysis"><span class="tab-icon">ğŸ“Š</span><span class="tab-label">ë¶„ì„</span></button>
  <button class="tab-btn" data-tab="predict"><span class="tab-icon">ğŸ”®</span><span class="tab-label">ì˜ˆì¸¡</span></button>
</div>

<div class="content">
  <div class="tab-content active" id="tab-home"></div>
  <div class="tab-content" id="tab-fixed"></div>
  <div class="tab-content" id="tab-record"></div>
  <div class="tab-content" id="tab-analysis"></div>
  <div class="tab-content" id="tab-predict"></div>
</div>

<div class="overlay" id="fixedModal" style="display:none"></div>
<div class="overlay" id="recordModal" style="display:none"></div>
<div class="overlay" id="labelModal" style="display:none"></div>

<script>
// ===== CURRENCIES =====
const CURRENCIES = {
  KRW: { symbol: 'â‚©', name: 'ì›', locale: 'ko-KR', decimals: 0 },
  USD: { symbol: '$', name: 'USD', locale: 'en-US', decimals: 2 },
  EUR: { symbol: 'â‚¬', name: 'EUR', locale: 'de-DE', decimals: 2 },
  JPY: { symbol: 'Â¥', name: 'ì—”', locale: 'ja-JP', decimals: 0 },
  GBP: { symbol: 'Â£', name: 'GBP', locale: 'en-GB', decimals: 2 },
  CNY: { symbol: 'Â¥', name: 'CNY', locale: 'zh-CN', decimals: 2 }
};

// ===== CATEGORIES & LABELS =====
const CATEGORIES = {
  income: ["ê¸‰ì—¬","ë¶€ìˆ˜ì…","ìš©ëˆìˆ˜ì…","ê¸°íƒ€ìˆ˜ì…"],
  fixedExpense: ["ì›”ì„¸","ê´€ë¦¬ë¹„","í†µì‹ ë¹„","êµ¬ë…ë£Œ","ë³´í—˜","êµí†µì •ê¸°ê¶Œ","ëŒ€ì¶œìƒí™˜","ê¸°íƒ€ê³ ì •"],
  variable: ["ì‹ë¹„","ì¹´í˜","ì‡¼í•‘","ë¬¸í™”ìƒí™œ","êµí†µ","ì˜ë£Œ","ê²½ì¡°ì‚¬","ìš©ëˆì§€ì¶œ","ê¸°íƒ€"]
};

const CAT_COLORS = {
  "ê¸‰ì—¬":"#4CAF50","ë¶€ìˆ˜ì…":"#66BB6A","ìš©ëˆìˆ˜ì…":"#81C784","ê¸°íƒ€ìˆ˜ì…":"#A5D6A7",
  "ì›”ì„¸":"#EF5350","ê´€ë¦¬ë¹„":"#F44336","í†µì‹ ë¹„":"#E53935","êµ¬ë…ë£Œ":"#D32F2F",
  "ë³´í—˜":"#C62828","êµí†µì •ê¸°ê¶Œ":"#FF7043","ëŒ€ì¶œìƒí™˜":"#FF5722","ê¸°íƒ€ê³ ì •":"#F4511E",
  "ì‹ë¹„":"#FF9800","ì¹´í˜":"#FFB74D","ì‡¼í•‘":"#AB47BC","ë¬¸í™”ìƒí™œ":"#7E57C2",
  "êµí†µ":"#42A5F5","ì˜ë£Œ":"#26C6DA","ê²½ì¡°ì‚¬":"#FFCA28","ìš©ëˆì§€ì¶œ":"#EC407A","ê¸°íƒ€":"#78909C"
};

const LABEL_COLORS = [
  {bg:"#E3F2FD",text:"#1565C0"},{bg:"#FCE4EC",text:"#C62828"},
  {bg:"#E8F5E9",text:"#2E7D32"},{bg:"#FFF3E0",text:"#E65100"},
  {bg:"#F3E5F5",text:"#6A1B9A"},{bg:"#E0F7FA",text:"#00695C"},
  {bg:"#FFF8E1",text:"#F57F17"},{bg:"#EFEBE9",text:"#4E342E"},
  {bg:"#E8EAF6",text:"#283593"},{bg:"#FFEBEE",text:"#B71C1C"}
];

const DEFAULT_LABELS = ["í•„ìˆ˜","ì ˆì•½ê°€ëŠ¥","ì—¬ê°€","íˆ¬ì","ë¹„ìƒ","ì„ ë¬¼","ì—…ë¬´","ê±´ê°•"];

const CHART_COLORS = ["#FF6B6B","#4ECDC4","#45B7D1","#96CEB4","#FFEAA7","#DDA0DD","#98D8C8","#F7DC6F","#BB8FCE","#85C1E9"];

const now = new Date();
const CY = now.getFullYear();
const CM = now.getMonth() + 1;
let selYear = CY, selMonth = CM;
let activeFilter = null; // label filter

// ===== APP DATA =====
let appData = {
  fixedIncome: [], fixedExpense: [], records: [],
  startBalance: 0, currency: 'KRW',
  labels: [...DEFAULT_LABELS]
};

// ===== STORAGE =====
function loadData() {
  try {
    const saved = localStorage.getItem('mam-app-data');
    if (saved) {
      const parsed = JSON.parse(saved);
      appData = { ...appData, ...parsed };
      if (!appData.labels || appData.labels.length === 0) appData.labels = [...DEFAULT_LABELS];
    }
  } catch(e) {}
}

function saveData() {
  try { localStorage.setItem('mam-app-data', JSON.stringify(appData)); } catch(e) {}
}

loadData();
document.getElementById('currencySelect').value = appData.currency;

// ===== UTILS =====
function cur() { return CURRENCIES[appData.currency]; }

function fmt(n) {
  const c = cur();
  if (n === 0) return c.symbol + '0';
  const abs = Math.abs(n);
  // Korean Won: special formatting with ë§Œ
  if (appData.currency === 'KRW' && abs >= 10000) {
    const man = Math.floor(abs / 10000);
    const rest = abs % 10000;
    return (n < 0 ? '-' : '') + c.symbol + man.toLocaleString() + 'ë§Œ' + (rest > 0 ? ' ' + rest.toLocaleString() : '');
  }
  const formatted = abs.toLocaleString(c.locale, { minimumFractionDigits: c.decimals, maximumFractionDigits: c.decimals });
  return (n < 0 ? '-' : '') + c.symbol + formatted;
}

function fmtShort(n) {
  const c = cur();
  const abs = Math.abs(n);
  if (appData.currency === 'KRW') {
    if (abs >= 100000000) return (n<0?'-':'') + c.symbol + (abs/100000000).toFixed(1) + 'ì–µ';
    if (abs >= 10000) return (n<0?'-':'') + c.symbol + Math.floor(abs/10000) + 'ë§Œ';
  } else {
    if (abs >= 1000000) return (n<0?'-':'') + c.symbol + (abs/1000000).toFixed(1) + 'M';
    if (abs >= 1000) return (n<0?'-':'') + c.symbol + (abs/1000).toFixed(1) + 'K';
  }
  return fmt(n);
}

function todayStr() {
  return `${CY}-${String(CM).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
}

function getMonthRecords(y, m) {
  const prefix = `${y}-${String(m).padStart(2,'0')}`;
  return appData.records.filter(r => r.date.startsWith(prefix)).sort((a,b) => a.date.localeCompare(b.date));
}

function fixedIncomeTotal() { return appData.fixedIncome.reduce((s,i) => s + i.amount, 0); }
function fixedExpenseTotal() { return appData.fixedExpense.reduce((s,i) => s + i.amount, 0); }
function isInc(cat) { return CATEGORIES.income.includes(cat); }

function labelColor(label) {
  let hash = 0;
  for (let i = 0; i < label.length; i++) hash = ((hash << 5) - hash) + label.charCodeAt(i);
  return LABEL_COLORS[Math.abs(hash) % LABEL_COLORS.length];
}

function labelHTML(labels) {
  if (!labels || labels.length === 0) return '';
  return '<div class="label-tags">' + labels.map(l => {
    const c = labelColor(l);
    return `<span class="label-tag" style="background:${c.bg};color:${c.text}">${l}</span>`;
  }).join('') + '</div>';
}

function changeCurrency(val) {
  appData.currency = val;
  saveData();
  renderCurrentTab();
}

// ===== TABS =====
let currentTab = 'home';

document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-' + btn.dataset.tab).classList.add('active');
    currentTab = btn.dataset.tab;
    activeFilter = null;
    renderTab(btn.dataset.tab);
  });
});

function renderCurrentTab() { renderTab(currentTab); }

function renderTab(tab) {
  switch(tab) {
    case 'home': renderHome(); break;
    case 'fixed': renderFixed(); break;
    case 'record': renderRecord(); break;
    case 'analysis': renderAnalysis(); break;
    case 'predict': renderPredict(); break;
  }
}

// ===== HOME =====
function renderHome() {
  const recs = getMonthRecords(CY, CM);
  const fi = fixedIncomeTotal(), fe = fixedExpenseTotal();
  const vi = recs.filter(r => isInc(r.category)).reduce((s,r) => s + r.amount, 0);
  const ve = recs.filter(r => !isInc(r.category)).reduce((s,r) => s + r.amount, 0);
  const total = fi + vi - fe - ve;
  const recent = recs.slice(-5).reverse();

  document.getElementById('tab-home').innerHTML = `
    <div class="balance-card">
      <div class="balance-label">${CY}ë…„ ${CM}ì›” ìˆ˜ì§€</div>
      <div class="balance-amount" style="color:${total >= 0 ? '#2ECC71' : '#FF6B6B'}">${total >= 0 ? '+' : ''}${fmt(total)}</div>
      <div class="balance-row">
        <span>ğŸŸ¢ ìˆ˜ì… ${fmt(fi + vi)}</span>
        <span>ğŸ”´ ì§€ì¶œ ${fmt(fe + ve)}</span>
      </div>
    </div>
    <div class="stats-grid">
      <div class="stat-card" style="background:linear-gradient(135deg,#a8e6cf,#88d8b0)">
        <div class="stat-emoji">ğŸ’µ</div><div class="stat-label">ê³ ì • ìˆ˜ì…</div><div class="stat-value">${fmt(fi)}</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#ff8a80,#ff5252)">
        <div class="stat-emoji">ğŸ </div><div class="stat-label">ê³ ì • ì§€ì¶œ</div><div class="stat-value">${fmt(fe)}</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#80d8ff,#40c4ff)">
        <div class="stat-emoji">ğŸ›ï¸</div><div class="stat-label">ë³€ë™ ì§€ì¶œ</div><div class="stat-value">${fmt(ve)}</div>
      </div>
      <div class="stat-card" style="background:linear-gradient(135deg,#ffe57f,#ffd740)">
        <div class="stat-emoji">âœ¨</div><div class="stat-label">ë³€ë™ ìˆ˜ì…</div><div class="stat-value">${fmt(vi)}</div>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title">ğŸ¦ í˜„ì¬ ê³„ì¢Œ ì”ê³ </h3>
      <p class="card-desc">ì˜ˆì¸¡ ê¸°ëŠ¥ì— ì‚¬ìš©ë¼ìš”.</p>
      <div class="input-row">
        <input type="number" class="input" id="startBalance" placeholder="ì˜ˆ: 5000000" value="${appData.startBalance || ''}">
        <span class="input-unit">${cur().symbol}</span>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title">ğŸ“‹ ìµœê·¼ ê¸°ë¡</h3>
      ${recent.length === 0 ? '<p class="empty-text">ì´ë²ˆ ë‹¬ ê¸°ë¡ì´ ì—†ì–´ìš” ğŸ“</p>'
        : recent.map(r => `
          <div class="record-row">
            <div class="record-dot" style="background:${CAT_COLORS[r.category]||'#999'}"></div>
            <div class="record-info">
              <span class="record-cat">${r.category}</span>
              <span class="record-date">${r.date.split('-')[2]}ì¼${r.memo ? ' Â· '+r.memo : ''}</span>
              ${labelHTML(r.labels)}
            </div>
            <span class="record-amount" style="color:${isInc(r.category)?'var(--green)':'var(--red)'}">
              ${isInc(r.category)?'+':'-'}${fmt(r.amount)}
            </span>
          </div>
        `).join('')}
    </div>
    <div class="card">
      <h3 class="card-title">ğŸ·ï¸ ë¼ë²¨ ê´€ë¦¬</h3>
      <p class="card-desc">ê¸°ë¡ì— ë¶™ì¼ ìˆ˜ ìˆëŠ” ë¼ë²¨ì„ ê´€ë¦¬í•´ìš”.</p>
      <div class="label-chips">
        ${appData.labels.map(l => {
          const c = labelColor(l);
          return `<span class="label-chip selected" style="border-color:${c.text};background:${c.bg};color:${c.text}">${l} <span onclick="removeLabel('${l}')" style="cursor:pointer;margin-left:2px;">âœ•</span></span>`;
        }).join('')}
        <button class="label-chip-add" onclick="showNewLabelPrompt()">+ ìƒˆ ë¼ë²¨</button>
      </div>
      <div id="newLabelArea" style="margin-top:8px;display:none;">
        <div class="input-row">
          <input class="input" id="newLabelInput" placeholder="ë¼ë²¨ ì´ë¦„" style="font-size:13px;padding:8px 12px;">
          <button class="add-btn" onclick="addNewLabel()" style="padding:8px 14px;">ì¶”ê°€</button>
        </div>
      </div>
    </div>
    <div class="card danger-zone">
      <h3 class="card-title">âš™ï¸ ì„¤ì •</h3>
      <button class="reset-btn" onclick="if(confirm('ì •ë§ ëª¨ë“  ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?')){appData={fixedIncome:[],fixedExpense:[],records:[],startBalance:0,currency:appData.currency,labels:[...DEFAULT_LABELS]};saveData();renderHome();}">ğŸ—‘ï¸ ëª¨ë“  ë°ì´í„° ì´ˆê¸°í™”</button>
    </div>
  `;

  document.getElementById('startBalance').addEventListener('change', (e) => {
    appData.startBalance = parseFloat(e.target.value) || 0;
    saveData();
  });
}

function showNewLabelPrompt() {
  const area = document.getElementById('newLabelArea');
  area.style.display = area.style.display === 'none' ? 'block' : 'none';
  if (area.style.display === 'block') document.getElementById('newLabelInput').focus();
}

function addNewLabel() {
  const input = document.getElementById('newLabelInput');
  const val = input.value.trim();
  if (!val) return;
  if (appData.labels.includes(val)) return alert('ì´ë¯¸ ìˆëŠ” ë¼ë²¨ì´ì—ìš”!');
  appData.labels.push(val);
  saveData();
  renderHome();
}

function removeLabel(name) {
  if (!confirm(`"${name}" ë¼ë²¨ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
  appData.labels = appData.labels.filter(l => l !== name);
  // Remove from all records too
  appData.records.forEach(r => {
    if (r.labels) r.labels = r.labels.filter(l => l !== name);
  });
  saveData();
  renderHome();
}

// ===== FIXED =====
function renderFixed() {
  const fi = fixedIncomeTotal(), fe = fixedExpenseTotal(), net = fi - fe;
  document.getElementById('tab-fixed').innerHTML = `
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">ğŸ’š ê³ ì • ìˆ˜ì…</h3>
        <button class="add-btn" onclick="showFixedModal('income')">+ ì¶”ê°€</button>
      </div>
      ${appData.fixedIncome.length === 0 ? '<p class="empty-text">ë“±ë¡ëœ ê³ ì • ìˆ˜ì…ì´ ì—†ì–´ìš”</p>'
        : appData.fixedIncome.map(i => `
          <div class="fixed-row">
            <div><span class="fixed-name">${i.name}</span><span class="fixed-cat">${i.category}</span></div>
            <div class="fixed-right">
              <span class="fixed-amount" style="color:var(--green)">+${fmt(i.amount)}</span>
              <button class="delete-btn" onclick="removeFixed('fixedIncome',${i.id})">âœ•</button>
            </div>
          </div>
        `).join('')}
      <div class="fixed-total">ì›” í•©ê³„: <strong style="color:var(--green)">${fmt(fi)}</strong></div>
    </div>
    <div class="card">
      <div class="card-header">
        <h3 class="card-title">â¤ï¸ ê³ ì • ì§€ì¶œ</h3>
        <button class="add-btn" onclick="showFixedModal('expense')">+ ì¶”ê°€</button>
      </div>
      ${appData.fixedExpense.length === 0 ? '<p class="empty-text">ë“±ë¡ëœ ê³ ì • ì§€ì¶œì´ ì—†ì–´ìš”</p>'
        : appData.fixedExpense.map(i => `
          <div class="fixed-row">
            <div><span class="fixed-name">${i.name}</span><span class="fixed-cat">${i.category}</span></div>
            <div class="fixed-right">
              <span class="fixed-amount" style="color:var(--red)">-${fmt(i.amount)}</span>
              <button class="delete-btn" onclick="removeFixed('fixedExpense',${i.id})">âœ•</button>
            </div>
          </div>
        `).join('')}
      <div class="fixed-total">ì›” í•©ê³„: <strong style="color:var(--red)">${fmt(fe)}</strong></div>
    </div>
    <div class="summary-card">
      <h3 class="card-title">ğŸ“Š ê³ ì • ìˆ˜ì§€ ìš”ì•½</h3>
      <div class="summary-amount" style="color:${net>=0?'var(--green)':'var(--red)'}">${net>=0?'+':''}${fmt(net)}</div>
      <div class="summary-desc">ë§¤ë‹¬ ê³ ì •ìœ¼ë¡œ ${net>=0?'ë‚¨ëŠ”':'ë¶€ì¡±í•œ'} ê¸ˆì•¡</div>
    </div>
  `;
}

// ===== RECORD =====
function renderRecord() {
  let recs = getMonthRecords(selYear, selMonth);
  
  // Collect all labels used this month
  const usedLabels = new Set();
  recs.forEach(r => { if (r.labels) r.labels.forEach(l => usedLabels.add(l)); });

  // Apply filter
  const filtered = activeFilter 
    ? recs.filter(r => r.labels && r.labels.includes(activeFilter))
    : recs;

  document.getElementById('tab-record').innerHTML = `
    <div class="month-selector">
      <button class="month-btn" onclick="changeMonth(-1)">â—€</button>
      <span class="month-label">${selYear}ë…„ ${selMonth}ì›”</span>
      <button class="month-btn" onclick="changeMonth(1)">â–¶</button>
    </div>
    <button class="big-add-btn" onclick="showRecordModal()">â• ìƒˆ ê¸°ë¡ ì¶”ê°€</button>
    
    ${usedLabels.size > 0 ? `
      <div class="label-filter-bar">
        <button class="label-filter-btn ${!activeFilter ? 'active' : ''}" onclick="setFilter(null)">ì „ì²´</button>
        ${[...usedLabels].map(l => `
          <button class="label-filter-btn ${activeFilter === l ? 'active' : ''}" onclick="setFilter('${l}')">${l}</button>
        `).join('')}
      </div>
    ` : ''}

    <div class="card">
      <h3 class="card-title">ğŸ“ ${selMonth}ì›” ê¸°ë¡ (${filtered.length}ê±´${activeFilter ? ' Â· #'+activeFilter : ''})</h3>
      ${filtered.length === 0 ? '<p class="empty-text">ê¸°ë¡ì´ ì—†ì–´ìš” âœ¨</p>'
        : filtered.map(r => `
          <div class="record-row">
            <div class="record-dot" style="background:${CAT_COLORS[r.category]||'#999'}"></div>
            <div class="record-info">
              <span class="record-cat">${r.category}</span>
              <span class="record-date">${r.date}${r.memo ? ' Â· '+r.memo : ''}</span>
              ${labelHTML(r.labels)}
            </div>
            <span class="record-amount" style="color:${isInc(r.category)?'var(--green)':'var(--red)'}">
              ${isInc(r.category)?'+':'-'}${fmt(r.amount)}
            </span>
            <button class="delete-btn" onclick="removeRecord(${r.id})">âœ•</button>
          </div>
        `).join('')}
    </div>
  `;
}

function setFilter(label) {
  activeFilter = label;
  renderRecord();
}

// ===== ANALYSIS =====
function renderAnalysis() {
  const months = [];
  let maxVal = 1;
  for (let i = 5; i >= 0; i--) {
    const d = new Date(CY, CM - 1 - i, 1);
    const y = d.getFullYear(), m = d.getMonth() + 1;
    const recs = getMonthRecords(y, m);
    const vi = recs.filter(r => isInc(r.category)).reduce((s,r) => s + r.amount, 0);
    const ve = recs.filter(r => !isInc(r.category)).reduce((s,r) => s + r.amount, 0);
    const inc = fixedIncomeTotal() + vi;
    const exp = fixedExpenseTotal() + ve;
    maxVal = Math.max(maxVal, inc, exp);
    months.push({ label: `${m}ì›”`, income: inc, expense: exp, savings: inc - exp });
  }

  const curRecs = getMonthRecords(CY, CM);
  const catMap = {};
  curRecs.filter(r => !isInc(r.category)).forEach(r => { catMap[r.category] = (catMap[r.category]||0) + r.amount; });
  appData.fixedExpense.forEach(f => { const cat = f.category||f.name; catMap[cat] = (catMap[cat]||0) + f.amount; });
  const catData = Object.entries(catMap).map(([name,value]) => ({name,value})).sort((a,b) => b.value - a.value);
  const catTotal = catData.reduce((s,c) => s + c.value, 0) || 1;

  // Label analysis
  const labelMap = {};
  curRecs.filter(r => !isInc(r.category)).forEach(r => {
    if (r.labels) r.labels.forEach(l => { labelMap[l] = (labelMap[l]||0) + r.amount; });
  });
  const labelData = Object.entries(labelMap).map(([name,value]) => ({name,value})).sort((a,b) => b.value - a.value);

  document.getElementById('tab-analysis').innerHTML = `
    <div class="card">
      <h3 class="card-title">ğŸ“Š ìµœê·¼ 6ê°œì›” ìˆ˜ì… vs ì§€ì¶œ</h3>
      <div class="chart-area" style="height:240px;">
        <div class="chart-bar-container">
          ${months.map(m => `
            <div class="chart-bar-group">
              <div class="chart-bar-pair">
                <div class="chart-bar" style="height:${(m.income/maxVal)*170}px;background:#4ECDC4;" data-value="${fmtShort(m.income)}"></div>
                <div class="chart-bar" style="height:${(m.expense/maxVal)*170}px;background:#FF6B6B;" data-value="${fmtShort(m.expense)}"></div>
              </div>
              <span class="chart-label">${m.label}</span>
            </div>
          `).join('')}
        </div>
      </div>
      <div class="chart-legend">
        <div class="legend-item"><div class="legend-dot" style="background:#4ECDC4"></div>ìˆ˜ì…</div>
        <div class="legend-item"><div class="legend-dot" style="background:#FF6B6B"></div>ì§€ì¶œ</div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ’° ìµœê·¼ 6ê°œì›” ì €ì¶•ì•¡</h3>
      <div class="chart-area" style="height:240px;">
        <div class="chart-bar-container">
          ${(() => {
            const maxSav = Math.max(...months.map(x => Math.abs(x.savings)), 1);
            return months.map(m => `
              <div class="chart-bar-group">
                <div class="chart-bar-pair">
                  <div class="chart-bar" style="height:${(Math.abs(m.savings)/maxSav)*170}px;background:${m.savings>=0?'#9B59B6':'#E74C3C'};" data-value="${fmtShort(m.savings)}"></div>
                </div>
                <span class="chart-label">${m.label}</span>
              </div>
            `).join('');
          })()}
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ© ì´ë²ˆ ë‹¬ ì§€ì¶œ ì¹´í…Œê³ ë¦¬</h3>
      ${catData.length === 0 ? '<p class="empty-text">ì§€ì¶œ ë°ì´í„°ê°€ ì—†ì–´ìš”</p>' : `
        <div style="display:flex;justify-content:center;padding:16px 0;">
          <svg width="220" height="220" viewBox="-110 -110 220 220">
            ${(() => {
              let angle = 0;
              return catData.map((c, i) => {
                const pct = c.value / catTotal;
                const sa = angle; angle += pct * 360;
                const s = pol(sa, 90), e = pol(angle, 90);
                const is2 = pol(sa, 50), ie = pol(angle, 50);
                const lg = pct > 0.5 ? 1 : 0;
                return '<path d="M'+is2.x+','+is2.y+' A50,50 0 '+lg+',1 '+ie.x+','+ie.y+' L'+e.x+','+e.y+' A90,90 0 '+lg+',0 '+s.x+','+s.y+' Z" fill="'+CHART_COLORS[i%CHART_COLORS.length]+'" opacity="0.85"/>';
              }).join('');
            })()}
          </svg>
        </div>
        <div class="pie-legend">
          ${catData.map((c,i) => `
            <div class="category-row">
              <div class="category-dot" style="background:${CHART_COLORS[i%CHART_COLORS.length]}"></div>
              <span class="category-name">${c.name} (${Math.round(c.value/catTotal*100)}%)</span>
              <span class="category-val">${fmt(c.value)}</span>
            </div>
          `).join('')}
        </div>
      `}
    </div>

    ${labelData.length > 0 ? `
      <div class="card">
        <h3 class="card-title">ğŸ·ï¸ ë¼ë²¨ë³„ ì§€ì¶œ ë¶„ì„</h3>
        ${labelData.map((l,i) => {
          const c = labelColor(l.name);
          const pct = Math.round(l.value / catTotal * 100);
          return `
            <div style="margin-bottom:10px;">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span class="label-tag" style="background:${c.bg};color:${c.text};font-size:12px;padding:3px 10px;">${l.name}</span>
                <span style="font-weight:700;font-size:13px;">${fmt(l.value)}</span>
              </div>
              <div style="background:#f0f0f0;border-radius:6px;height:8px;overflow:hidden;">
                <div style="background:${c.text};height:100%;width:${Math.min(pct,100)}%;border-radius:6px;transition:width 0.5s;"></div>
              </div>
            </div>
          `;
        }).join('')}
      </div>
    ` : ''}
  `;
}

function pol(angle, r) {
  const rad = (angle - 90) * Math.PI / 180;
  return { x: Math.round(r * Math.cos(rad)*100)/100, y: Math.round(r * Math.sin(rad)*100)/100 };
}

// ===== PREDICT =====
function renderPredict() {
  const fi = fixedIncomeTotal(), fe = fixedExpenseTotal();
  let balance = appData.startBalance;
  const predictions = [];

  for (let i = 0; i < 12; i++) {
    const d = new Date(CY, CM - 1 + i, 1);
    const y = d.getFullYear(), m = d.getMonth() + 1;
    const recs = getMonthRecords(y, m);
    const vi = recs.filter(r => isInc(r.category)).reduce((s,r) => s + r.amount, 0);
    const ve = recs.filter(r => !isInc(r.category)).reduce((s,r) => s + r.amount, 0);
    const totalInc = fi + vi, totalExp = fe + ve;
    balance += totalInc - totalExp;
    const isPast = y < CY || (y === CY && m < CM);
    const isCurrent = y === CY && m === CM;
    predictions.push({ label: `${m}ì›”`, income: totalInc, expense: totalExp, balance, isPast, isCurrent });
  }

  document.getElementById('tab-predict').innerHTML = `
    <div class="predict-card">
      <h3 class="card-title">ğŸ”® í–¥í›„ 12ê°œì›” ì”ê³  ì˜ˆì¸¡</h3>
      <p class="card-desc">í˜„ì¬ ì”ê³  <strong>${fmt(appData.startBalance)}</strong> ê¸°ì¤€, ë§¤ë‹¬ ê³ ì • ìˆ˜ì…/ì§€ì¶œ ë°˜ì˜</p>
      <div class="chart-area" style="height:220px;">
        <svg width="100%" height="220" viewBox="0 0 360 200" class="chart-svg" preserveAspectRatio="none">
          <defs>
            <linearGradient id="areaGrad" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stop-color="#42A5F5" stop-opacity="0.3"/>
              <stop offset="100%" stop-color="#42A5F5" stop-opacity="0.02"/>
            </linearGradient>
          </defs>
          ${(() => {
            const minB = Math.min(...predictions.map(p => p.balance));
            const maxB = Math.max(...predictions.map(p => p.balance));
            const range = maxB - minB || 1;
            const pts = predictions.map((p, i) => ({
              x: 15 + (i / 11) * 330,
              y: 180 - ((p.balance - minB) / range) * 160
            }));
            const line = pts.map((p, i) => `${i===0?'M':'L'}${p.x},${p.y}`).join(' ');
            const area = line + ` L${pts[11].x},185 L${pts[0].x},185 Z`;
            const dots = pts.map((p, i) =>
              `<circle cx="${p.x}" cy="${p.y}" r="4" fill="${predictions[i].balance>=0?'#1E88E5':'#E74C3C'}" stroke="#fff" stroke-width="2"/>`
            ).join('');
            const labels = predictions.map((p, i) => {
              const x = 15 + (i / 11) * 330;
              return i % 2 === 0 ? `<text x="${x}" y="198" text-anchor="middle" class="chart-axis-label">${p.label}</text>` : '';
            }).join('');
            return `<path d="${area}" fill="url(#areaGrad)"/><path d="${line}" fill="none" stroke="#1E88E5" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>${dots}${labels}`;
          })()}
        </svg>
      </div>
    </div>

    <div class="card">
      <h3 class="card-title">ğŸ“… ì›”ë³„ ìƒì„¸ ì˜ˆì¸¡</h3>
      ${predictions.map((p, i) => `
        <div class="predict-row" style="${p.isCurrent ? 'background:#FFF9C4' : ''}">
          <div class="predict-month">
            ${p.label}
            ${p.isCurrent ? '<span class="badge badge-current">í˜„ì¬</span>' : ''}
            ${!p.isPast && !p.isCurrent ? '<span class="badge badge-future">ì˜ˆì¸¡</span>' : ''}
          </div>
          <div class="predict-details">
            <span style="color:var(--green)">+${fmtShort(p.income)}</span>
            <span style="color:var(--red)">-${fmtShort(p.expense)}</span>
          </div>
          <div class="predict-balance" style="color:${p.balance>=0?'var(--blue)':'var(--red)'}">${fmtShort(p.balance)}</div>
        </div>
      `).join('')}
    </div>

    <div class="insight-card">
      <h3 class="card-title">ğŸ’¡ ì¸ì‚¬ì´íŠ¸</h3>
      ${fi - fe > 0
        ? `<p class="insight-text">ë§¤ë‹¬ ê³ ì •ìœ¼ë¡œ <strong style="color:var(--green)">${fmt(fi-fe)}</strong>ì´ ë‚¨ì•„ìš”. 1ë…„ì´ë©´ <strong>${fmt((fi-fe)*12)}</strong>ì„ ëª¨ì„ ìˆ˜ ìˆì–´ìš”! ğŸ‰</p>`
        : fi - fe < 0
          ? `<p class="insight-text">ë§¤ë‹¬ ê³ ì • ì§€ì¶œì´ ìˆ˜ì…ë³´ë‹¤ <strong style="color:var(--red)">${fmt(Math.abs(fi-fe))}</strong> ë§ì•„ìš”. ê³ ì • ì§€ì¶œì„ ì¤„ì´ê±°ë‚˜ ìˆ˜ì…ì„ ëŠ˜ë¦¬ëŠ” ë°©ë²•ì„ ê³ ë¯¼í•´ë³´ì„¸ìš” ğŸ’ª</p>`
          : '<p class="insight-text">ê³ ì • ìˆ˜ì…/ì§€ì¶œì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”! ğŸ“Œ ê³ ì • íƒ­ì—ì„œ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</p>'}
    </div>
  `;
}

// ===== ACTIONS =====
function changeMonth(dir) {
  selMonth += dir;
  if (selMonth > 12) { selMonth = 1; selYear++; }
  if (selMonth < 1) { selMonth = 12; selYear--; }
  activeFilter = null;
  renderRecord();
}

function showFixedModal(type) {
  const cats = type === 'income' ? CATEGORIES.income : CATEGORIES.fixedExpense;
  const modal = document.getElementById('fixedModal');
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <h3 class="modal-title">${type === 'income' ? 'ğŸ’š ê³ ì • ìˆ˜ì… ì¶”ê°€' : 'â¤ï¸ ê³ ì • ì§€ì¶œ ì¶”ê°€'}</h3>
      <label>ì´ë¦„</label>
      <input class="modal-input" id="fName" placeholder="ì˜ˆ: ì›”ê¸‰, ì›”ì„¸">
      <label>ì¹´í…Œê³ ë¦¬</label>
      <select class="modal-input" id="fCat">${cats.map(c => `<option value="${c}">${c}</option>`).join('')}</select>
      <label>ì›” ê¸ˆì•¡ (${cur().symbol})</label>
      <input class="modal-input" id="fAmount" type="number" placeholder="ì˜ˆ: 3000000">
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('fixedModal')">ì·¨ì†Œ</button>
        <button class="confirm-btn" onclick="addFixed('${type}')">ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>
  `;
  modal.onclick = () => closeModal('fixedModal');
}

function addFixed(type) {
  const name = document.getElementById('fName').value;
  const cat = document.getElementById('fCat').value;
  const amount = parseFloat(document.getElementById('fAmount').value);
  if (!name || !amount) return alert('ì´ë¦„ê³¼ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
  const key = type === 'income' ? 'fixedIncome' : 'fixedExpense';
  appData[key].push({ id: Date.now(), name, category: cat, amount });
  saveData(); closeModal('fixedModal'); renderFixed();
}

function removeFixed(key, id) {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  appData[key] = appData[key].filter(i => i.id !== id);
  saveData(); renderFixed();
}

// ===== RECORD MODAL WITH LABELS =====
let selectedLabels = [];

function showRecordModal() {
  selectedLabels = [];
  const modal = document.getElementById('recordModal');
  modal.style.display = 'flex';
  modal.innerHTML = `
    <div class="modal" onclick="event.stopPropagation()">
      <h3 class="modal-title">ğŸ“ ìƒˆ ê¸°ë¡ ì¶”ê°€</h3>
      <label>ë‚ ì§œ</label>
      <input class="modal-input" id="rDate" type="date" value="${todayStr()}">
      <label>ì¹´í…Œê³ ë¦¬</label>
      <select class="modal-input" id="rCat">
        <optgroup label="ğŸ’° ìˆ˜ì…">${CATEGORIES.income.map(c => `<option value="${c}">${c}</option>`).join('')}</optgroup>
        <optgroup label="ğŸ›ï¸ ë³€ë™ ì§€ì¶œ">${CATEGORIES.variable.map(c => `<option value="${c}">${c}</option>`).join('')}</optgroup>
      </select>
      <label>ê¸ˆì•¡ (${cur().symbol})</label>
      <input class="modal-input" id="rAmount" type="number" placeholder="ì˜ˆ: 15000">
      <label>ë©”ëª¨ (ì„ íƒ)</label>
      <input class="modal-input" id="rMemo" placeholder="ì˜ˆ: ì¹œêµ¬ë‘ ì ì‹¬">
      <label>ğŸ·ï¸ ë¼ë²¨ (ì„ íƒ, ì—¬ëŸ¬ê°œ ê°€ëŠ¥)</label>
      <div class="label-chips" id="labelChips">
        ${appData.labels.map(l => {
          const c = labelColor(l);
          return `<button class="label-chip" data-label="${l}" onclick="toggleLabel(this,'${l}')" style="border-color:#E0E0E0">${l}</button>`;
        }).join('')}
      </div>
      <div class="modal-btns">
        <button class="cancel-btn" onclick="closeModal('recordModal')">ì·¨ì†Œ</button>
        <button class="confirm-btn" onclick="addRecord()">ì¶”ê°€í•˜ê¸°</button>
      </div>
    </div>
  `;
  modal.onclick = () => closeModal('recordModal');
  setTimeout(() => { document.getElementById('rCat').value = CATEGORIES.variable[0]; }, 10);
}

function toggleLabel(el, label) {
  if (selectedLabels.includes(label)) {
    selectedLabels = selectedLabels.filter(l => l !== label);
    el.classList.remove('selected');
    el.style.borderColor = '#E0E0E0';
    el.style.background = '#fff';
    el.style.color = '#666';
  } else {
    selectedLabels.push(label);
    const c = labelColor(label);
    el.classList.add('selected');
    el.style.borderColor = c.text;
    el.style.background = c.bg;
    el.style.color = c.text;
  }
}

function addRecord() {
  const date = document.getElementById('rDate').value;
  const cat = document.getElementById('rCat').value;
  const amount = parseFloat(document.getElementById('rAmount').value);
  const memo = document.getElementById('rMemo').value;
  if (!date || !amount) return alert('ë‚ ì§œì™€ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!');
  appData.records.push({
    id: Date.now(), date, category: cat, amount, memo,
    labels: [...selectedLabels]
  });
  saveData(); closeModal('recordModal'); renderRecord();
}

function removeRecord(id) {
  if (!confirm('ì‚­ì œí• ê¹Œìš”?')) return;
  appData.records = appData.records.filter(r => r.id !== id);
  saveData(); renderRecord();
}

function closeModal(id) { document.getElementById(id).style.display = 'none'; }

// ===== SERVICE WORKER =====
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// Initial render
renderHome();
</script>
</body>
</html>
